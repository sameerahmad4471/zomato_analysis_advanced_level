1 : After goldusers_signup which item was purchased by each customer

select * from 
(select a.*,rank() over(partition by userid order by created_date) rnk
from 
(select s.userid,s.created_date,s.product_id ,g.gold_signup_date from sales s  join goldusers_signup
g on s.userid = g.userid and created_date >= gold_signup_date)a)b
where rnk = 1


2 : Befor goldusers_signup which item was purchased by customer

select * from 
(select c.* ,rank() over(partition by userid order by created_date desc) rnk from
(select s.userid,s.created_date,s.product_id from sales s
join goldusers_signup g on s.userid = g.userid and created_date
<= gold_signup_date )c)d
where rnk = 1

3 : what is the total orders and total amount spend by each customer

select userid ,count(created_date) ,sum(price) from
(select e.*,p.price from
(select s.userid,s.created_date,s.product_id from sales s
join goldusers_signup g on s.userid = g.userid and created_date <= 
gold_signup_date)e
join product p on e.product_id = p.product_id) f 
group by userid
